---
layout: post
title: Race Condition
subtitle: ë‹¤ì¤‘ ì“°ë ˆë“œ í˜¹ì€ í”„ë¡œì„¸ìŠ¤ ê°„ ê³µìœ  ìì› ì‹¸ì›€
author: g3rm
categories: Web
banner:
  image: /assets/images/banners/home.gif
  opacity: 0.618
  background: "#000"
  heading_style: "font-size: 4.25em; font-weight: bold;"
  subheading_style: "color: gold"
tags:
  - Race_Condition
  - Last-Byte_Sync
  - Single_Packet_Attack
sidebar:
---
## Intro
Race Conditionì€ ë‹¤ì¤‘ í”„ë¡œì„¸ìŠ¤ í˜¹ì€ ì“°ë ˆë“œê°€ í•˜ë‚˜ì˜ ê³µìœ  ìì›ì— ëŒ€í•œ ì ‘ê·¼ ë° ìˆ˜ì •ì„ ë™ì‹œì— í•´ì„œ í•œ ìª½ ê²°ê³¼ê°€ ë¬´ì‹œ ë‹¹í•˜ê±°ë‚˜, ì˜ëª»ëœ ê²°ê³¼ê°€ ë„ì¶œë˜ëŠ” ì·¨ì•½ì ì…ë‹ˆë‹¤.   
![](assets/images/posts/2024-12-12-Race-Condition/4a5981ed1eef80144ef6c9deabb8240b_MD5.jpeg)   

### ê³µê²© ì›ë¦¬
#### HTTP/1 - Last-Byte Sync
HTTP/1ì˜ ê²½ìš° HTTP ìš”ì²­ì´ ì™„ë£Œ ë˜ì–´ì•¼ ì„œë²„ì—ì„œ ìš”ì²­ì„ ì²˜ë¦¬í•˜ê¸° ë•Œë¬¸ì— ê° íŒ¨í‚·ì˜ Last-Byteì„ ë‚¨ê²¨ë‘” ì±„ë¡œ ì „ì†¡í•œ ë’¤ ëª¨ì•˜ë˜ Last-Byteë“¤ì„ í•œë²ˆì— ë³´ë‚´ ë™ì‹œì— ìš”ì²­ì„ ì²˜ë¦¬í•˜ë„ë¡ í•˜ê²Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.   
![](/assets/images/posts/2024-12-12-Race-Condition/637bb68e80eecd3651050e9413eb5300_MD5.jpeg)   

#### HTTP/2 - Single Packet Attack
HTTP/2ì˜ ê²½ìš° í•˜ë‚˜ì˜ íŒ¨í‚·ì— ì—¬ëŸ¬ ê°œì˜ ìš”ì²­ì„ ì „ì†¡í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ì•„ë˜ì™€ ê°™ì€ ëª¨ìŠµìœ¼ë¡œ í•œë²ˆì— ìš”ì²­ì„ ë³´ë‚´ë²„ë¦½ë‹ˆë‹¤.ğŸ˜„   

![](/assets/images/posts/2024-12-12-Race-Condition/f4a02b5957531e299cb0525831491fc9_MD5.jpeg)   

>â˜‘ï¸í•œë²ˆì— ìš”ì²­ì„ ë³´ë‚´ê¸° ë•Œë¬¸ì— ì‹œê°„ ì°¨ì´ê°€ ì§§ì•„ HTTP/2ê°€ HTTP/1ë³´ë‹¤ Race Conditionì„ ë” ì˜ êµ¬í˜„í•  ìˆ˜ ìˆê²Œë©ë‹ˆë‹¤.    

## Detect & Exploit 
### Detect
#### Limit overrun
ë¡œê·¸ì¸ ì‹¤íŒ¨ íšŸìˆ˜ ì œí•œ, ì¼íšŒì„± í• ì¸ ì½”ë“œ, reCAPTCHA ë“± íšŸìˆ˜ ì œí•œì´ ìˆëŠ” ë¡œì§ì˜ ê²½ìš° Race Conditionì„ ì‹œë„í•  Race Windowê°€ ì¡´ì¬í•  ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤. - [Turbo Intruder](https://portswigger.net/bappstore/9abaa233088242e8be252cd4ff534988) ì‚¬ìš©    

#### Single End Point
ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™”, ì´ë©”ì¼ ì¸ì¦ ë“±ê³¼ ê°™ì€ ê¸°ëŠ¥ì—ì„œ ë°œìƒí•  ìˆ˜ ìˆê³ , í•´ë‹¹ ê¸°ëŠ¥ì´ ë¹„ì •ìƒì ìœ¼ë¡œ ë¹ ë¥´ë‹¤ë©´ Race Windowê°€ ì¡´ì¬í•  ê°€ëŠ¥ì„±ì´ ìˆìŠµë‹ˆë‹¤.   

ê·¸ ì´ìœ ëŠ” ë§Œì•½ì— ì´ë©”ì¼ ì¸ì¦ì˜ ê²½ìš° í•´ë‹¹ ì´ë©”ì¼ì— ì¸ì¦ ì½”ë“œê°€ ë‹´ê¸´ ë©”ì¼ì„ ë³´ë‚´ê²Œ ë˜ëŠ”ë°, ì´ëŸ¬í•œ ê³¼ì •ì´ ë¹„ì •ìƒì ìœ¼ë¡œ ë¹ ë¥´ë‹¤ë©´ ì´ë©”ì¼ ì¸ì¦ ìš”ì²­(íŒ¨í‚·)ì„ ì²˜ë¦¬í•˜ëŠ” ìŠ¤ë ˆë“œì™€ ë©”ì¼ì„ ë³´ë‚´ëŠ” ìŠ¤ë ˆë“œê°€ ë‹¤ë¥´ë‹¤ëŠ” ê²ƒì„ ìœ ì¶”í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.   

ì˜ˆë¥¼ ë“¤ì–´ ì•„ë˜ì™€ ê°™ì´ ë‘ ìš”ì²­ì„ ë™ì‹œì— ë³´ë‚´ê²Œ ëì„ ë•Œ, ì¸ì¦ ì½”ë“œê°€ ë‹´ê¸´ ë©”ì¼ì´ ê¼¬ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.   
```
# single packet 1
POST /email-auth HTTP/2
Host: victim.com

email=g3rm@attacker.com

# single packet 2
POST /email-auth HTTP/2
Host: victim.com

email=g3rm@victim.com
```   

```
ë°›ëŠ”ì´ : g3rm@attacker.com
ì œëª© : ì´ë©”ì¼ ì¸ì¦ ì½”ë“œ
ë‚´ìš© : g3rm@victim.com ì´ë©”ì¼ì˜ ì¸ì¦ì½”ë“œëŠ” 1234 ì…ë‹ˆë‹¤.
```   

#### Multi End Point
ê°€ë ¹ ì‡¼í•‘ëª°ê³¼ ê°™ì€ ì„œë¹„ìŠ¤ê°€ ìˆê³  í•´ë‹¹ ì„œë¹„ìŠ¤ì˜ êµ¬ë§¤ ë¡œì§ì´ `ì§€ë¶ˆí™•ì¸` -> `ì¥ë°”êµ¬ë‹ˆ í™•ì¸` ìˆœì„œë¡œ ì´ë£¨ì–´ì ¸ ìˆë‹¤ë©´, í•´ë‹¹ ê³¼ì • ì‚¬ì´ì— Race Windowê°€ ë°œìƒí•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.    
![](/assets/images/posts/2024-12-12-Race-Condition/26b41a0d3526c8f0ed4d6f98e64db2c6_MD5.jpeg)   

>â˜‘ï¸Race Conditionì€ ì œê°€ ì„¤ëª…í•œ ë¶€ë¶„ ì™¸ ìì›ì— ë™ì‹œì— ì ‘ê·¼í•˜ë©´ ë°œìƒí•˜ê¸°ì— ìˆ˜ë§ì€ ì·¨ì•½ì ì„ ë„ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë¬¼ë¡  ì´ê²ƒì„ ì‹¤ì œ ìƒí™©ì—ì„œ ë°œê²¬í•˜ëŠ” ê±´ ê°ê°ì ì¸ ìš”ì†Œì¼ ê²ƒ ê°™ìŠµë‹ˆë‹¤. - ë­”ê°€ ë™ì‹œì— ì ‘ê·¼í•˜ëŠ” ë¡œì§ì¼ ê±° ê°™ì€ë°....?ğŸ¤£    

### Exploit
EQSTLabì— ì¢‹ì€ ë¬¸ì œê°€ ìˆì–´ì„œ í•´ë‹¹ ë¬¸ì œ í’€ì´ë¡œ Exploitì„ ì ê² ìŠµë‹ˆë‹¤ - [EQSTLab Race_Condition](https://github.com/EQSTLab/Race_Condition)     
ê°„ëµí•˜ê²Œ ì½”ë“œì— ëŒ€í•œ ì†Œê°œë¥¼ í•˜ê² ìŠµë‹ˆë‹¤.   
1. ê²°ì œ ì™„ë£Œ ì‹œ ì •ìƒì ìœ¼ë¡œ ê²°ì œê°€ ë˜ì—ˆëŠ”ì§€ ì¥ë°”êµ¬ë‹ˆì— ìˆëŠ” ë¬¼ê±´ë“¤ì˜ ê¸ˆì•¡ì„ ë”í•œë‹¤. **[ì§€ë¶ˆí™•ì¸]**   
	```php
	# kcp_api_pay.php 13 line
	$stmt = $conn->prepare("SELECT sum(good_mny) AS total FROM orders WHERE buyr_name = ?");
	```   
	
2. ê²°ì œê°€ ëœ ê²ƒì„ í™•ì¸ í›„ ìì‹ ì˜ DBì— ìœ ì €ê°€ ì‚° ë¬¼ê±´ì— ëŒ€í•œ ì •ë³´ë¥¼ ì¥ë°”êµ¬ë‹ˆì—ì„œ ì–»ëŠ”ë‹¤. **[ì¥ë°”êµ¬ë‹ˆ í™•ì¸]**    
	```php
	# kcp_api_pay.php 249 line (RACE CONDITION POINT)
	Â $stmt = $conn->prepare("UPDATE payments SET pay_method = ?, tno = ?, amount = (SELECT sum(good_mny) FROM orders WHERE buyr_name = ? ) WHERE buyr_name = ? ");
	```   

>â˜‘ï¸ê²°ì œ ì‹œ, ì •ìƒì ìœ¼ë¡œ ê²°ì œê°€ ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ë¡œì§ê³¼ í™•ì¸ í›„ DBì— ì—…ë°ì´íŠ¸í•˜ëŠ” ë¡œì§ì—ì„œ ë‘˜ ë‹¤ ì¥ë°”êµ¬ë‹ˆë¥¼ í™•ì¸[ê³µìœ  ìì› ì‚¬ìš©]í•˜ê¸°ì— ê³µê²© í¬ì¸íŠ¸ê°€ ìƒì„±ë©ë‹ˆë‹¤.    

---

ë‹¨ìˆœí•˜ê²Œ ê²°ì œ ì„œë¹„ìŠ¤ë¥¼ í†µí•´ ê²°ì œê°€ ëë‚œ í›„ **ê²°ì œë¥¼ í™•ì¸í•˜ëŠ” íŒ¨í‚·**ê³¼ **ì¥ë°”êµ¬ë‹ˆì— ë¬¼ê±´ì„ ë‹´ëŠ” íŒ¨í‚·**ì„ ë™ì‹œì— ë³´ë‚´ë©´ ë©ë‹ˆë‹¤.   

>âš ï¸ phpì˜ ê²½ìš° sessionì„ íŒŒì¼ë¡œ ê´€ë¦¬í•˜ê¸°ì— í•´ë‹¹ íŒŒì¼ì— ëŒ€í•œ Race conditionì„ ë§‰ê¸° ìœ„í•´ phplockì´ ì¡´ì¬í•©ë‹ˆë‹¤. ë”°ë¼ì„œ ì„¸ì…˜ì„ ë‘ ê°œ ë°œê¸‰ ë°›ì•„ì„œ ì‚¬ìš©í•˜ì…”ì•¼ ë©ë‹ˆë‹¤.   

1. 10ì›ìœ¼ë¡œ ê²°ì œê°€ ì™„ë£Œëœ ëª¨ìŠµ
	![](/assets/images/posts/2024-12-12-Race-Condition/866c4291afd09a5d4f81ea8ff56a35ee_MD5.jpeg)   
2. DBì—ëŠ” 10000010ì›ìœ¼ë¡œ ë¬¼ê±´ 2ê°œê°€ ê²°ì œëœ ê²ƒìœ¼ë¡œ ì…ë ¥ëœ ëª¨ìŠµ
	![](/assets/images/posts/2024-12-12-Race-Condition/6455dfec128512767972d686309e7b28_MD5.jpeg)   

## Security Measures
### Threadì˜ ë™ê¸°í™”
ê³µìœ  ìì›ì— ëŒ€í•œ ì ‘ê·¼ì„ ì œì–´í•˜ì—¬ í•˜ë‚˜ì˜ Threadë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ í•´ì•¼ í•©ë‹ˆë‹¤.   
ì˜ˆë¥¼ ë“¤ì–´ Javaì˜ synchronizedì™€ ê°™ì€ ë™ê¸°í™”ë¥¼ ì‚¬ìš©í•˜ì—¬ ê³µìœ  ìì›ì— ëŒ€í•´ì„œ ì¶©ëŒì´ ì¼ì–´ë‚˜ì§€ ì•Šë„ë¡ ê°œë°œí•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.    
### Message ê¸°ë°˜ 
Threadë“¤ì´ ì„œë¡œ ë©”ì„¸ì§€ë¥¼ ì£¼ê³  ë°›ëŠ” í†µì‹  êµ¬ì¡°ë¥¼ í†µí•´ ìì› ê³µìœ ë¥¼ í”¼í•˜ëŠ” ë°©ë²•ì´ ìˆìŠµë‹ˆë‹¤.   
   
>ğŸ˜…ë³´ì•ˆ ëŒ€ì±…ì´ ê°œë°œìª½ê³¼ ê´€ë ¨ì´ ê¹Šë‹¤ ë³´ë‹ˆ ìì„¸íˆ ì ì§€ ëª»í•œ ì  ì´í•´ ë°”ëë‹ˆë‹¤.

## References
[race-condition](https://www.imperva.com/learn/application-security/race-condition/)   
[PortSwigger Race conditions](https://portswigger.net/web-security/race-conditions)   
[PortSwigger Research](https://portswigger.net/research/smashing-the-state-machine)   