---
layout: post
title: Android Basic
subtitle: Android 진단 시 필요한 정보들 정리
author: g3rm
categories: 
banner:
  image: /assets/images/banners/home.gif
  opacity: 0.618
  background: "#000"
  heading_style: "font-size: 4.25em; font-weight: bold;"
  subheading_style: "color: gold"
tags:
  - example
  - markdown
sidebar:
---
>당분간 모바일 해킹을 할 시간이 부족해 당장 기억나는 부분들로만 정리한 내용



## Android 구조 및 동작이해

![](/assets/images/posts/2025-04-28-Android/cb314902a6b4a42ed8dc26012de1681d_MD5.jpeg)![](/assets/images/posts/2025-04-28-Android/c758f21c8c647ba2e4c36c669faf6173_MD5.jpeg)

## Android 진단 환경 구축
### ADB
SDK 설치 (**Android Studio 설치하면 알아서 깔림**)
- [https://developer.android.com/studio/releases/platform-tools](https://developer.android.com/studio/releases/platform-tools)
- SDK 설치 후 platform-tools 디렉토리 환경 변수 등록

*For Mac*
터미널에서 `code ~/.zshrc` 입력 후 아래와 같이 환경 변수 등록
![](/assets/images/posts/2025-04-28-Android/1f498c0b38fbc453b5b95aeddea2f08b_MD5.jpeg)

### KeyStore
#### Android Studio
[File -> New Project -> Build] 메뉴에서 아래와 같이 진행
![](/assets/images/posts/2025-04-28-Android/a337c77ec1064a83c5bf4b9adc873afd_MD5.jpeg)
#### KeyTool
`keytool -genkey -v -keystore dogyun.keystore -alias dogyun -keyalg RSA -keysize 2048 -validity 10000` 명령어 입력 후 생성
![](/assets/images/posts/2025-04-28-Android/40467f9fd495c037236002f1bfbbb6c6_MD5.jpeg)

### Proxy
#### 낮은 버전의 경우
단순히 127.0.0.1:burp_port 들어가서 인증서 다운로드 후 Astro에서 인증서 설치 진행

#### 높은 버전의 경우
1. Burp Suite [Proxy] - [Options] - [Import/export certificate] 기능을 통해 인증서 파일을 추출
2. `openssl x509 -inform DER -in cacert.cer -out cacert.pem` pem 변환
3. `openssl x509 -inform PEM -subject_hash_old -in cacert.pem` 해쉬값 추출
4. `mv cacert.pem 9a5ba575.0` 파일명 해쉬값으로 변경
5. `adb push 9a5ba575.0 /data/local/tmp`
6. `mount -o rw,remount /` 쓰기권한 마운트 시키기
7. `cp 9a5ba575.0 /system/etc/security/cacerts/`
    1. `ls -l /system/etc/security/cacerts/ | grep 9a5ba575`
8. `mount -o ro,remount /`
9. [설정] - [생체 인식 및 보안] - [기타 보안 설정] - [인증서 확인] 에서 확인

## 정적 분석
### APK 추출
1. ASTRO 백업 기능 이용
![](/assets/images/posts/2025-04-28-Android/f702c56792f7665c4dace347953a8581_MD5.jpeg)
2. 플레이스토어에서 APK 다운로드
![](/assets/images/posts/2025-04-28-Android/e9e8ba9efc283ef7ba597a2d2a60134c_MD5.jpeg)
![](/assets/images/posts/2025-04-28-Android/81f4573e2c8f2bcbaf8eb26a4e623f1c_MD5.jpeg)
3. APK Extractor 이용
![](/assets/images/posts/2025-04-28-Android/6e7784ba8ddf43803323d8d4354055ff_MD5.jpeg)

### 디컴파일
1. jadx
APK 파일 그냥 jadx에 넣으면 됨
2. APK Tool 이용
[https://github.com/iBotPeaches/Apktool/releases/tag/v2.8.0](https://github.com/iBotPeaches/Apktool/releases/tag/v2.8.0)
```shell
java -jar apktool_2.8.0.jar d "디컴파일 할 앱 이름"
```
![](/assets/images/posts/2025-04-28-Android/44089d04f9c58bc20e946e69e368b072_MD5.jpeg)
3. dex2jar 이용
[https://github.com/pxb1988/dex2jar/releases/tag/v2.1](https://github.com/pxb1988/dex2jar/releases/tag/v2.1)
```shell
# Windows의 경우 bat 파일로 돌리면 됨
./d2j-dex2jar.sh apk
```

## 동적 분석
### 메모리 관련
#### fridump
```shell
# string 뽑기
Python3 fridump3.py -u pid -s
```
![](/assets/images/posts/2025-04-28-Android/817bc94fee95ea682e5aff93f106ca82_MD5.jpeg)
#### AM
1. Manifest에서 debugging이 되는지 확인
![](/assets/images/posts/2025-04-28-Android/a02944868b8ccd11dfbc59fe0e21220f_MD5.jpeg)
2. App pid 정보 확인 (ps | grep diva) 및 am dump
![](/assets/images/posts/2025-04-28-Android/24c8d805b3c725f4cce69e7473fe9d1a_MD5.jpeg)

#### 실시간 메모리 후킹
```javascript
function memoryScan() {
    try {
	  var search_string = ['']; // 찾을 패턴의 문자열 Find string ex) ['a'] Or ['a','b']
        var Modify_string = ['']; // 변조할 문자열 Modify string ex) ['a'] Or ['a','b']
        var patched = false;
		
        search_string.forEach(function (patt, index) {
            var pattern = patt
                .split('')
                .map(char => char.charCodeAt(0).toString(16))
                .join(' ');
			
            Process.enumerateRanges('rw-', {
                onMatch: function (range) {

                    var result = Memory.scanSync(range.base, range.size, pattern); // 패턴 직전 메모리를 원하면 4번째 인자 추가
                    if (result.length > 0) {
					
                        result.forEach(function (match) {
							console.log("");
					console.log("\x1b[31m" + '[*] Scan String: ' + patt + "\x1b[0m");
                            console.log("\x1b[36m" + '[*] String Address: ' + match.address + "\x1b[0m");									                     
                            console.log(hexdump(match.address, { offset: 0, length: 128 }));
                            var mempatch = Modify_string[index];

                            var hexData = [];
                            for (var i = 0; i < mempatch.length; i++) {
                                var hexChar = '0x' + mempatch.charCodeAt(i).toString(16);
                                hexData.push(hexChar);
                            }

                            var nullBytesToAdd = patt.length - mempatch.length;

                            for (var i = 0; i < nullBytesToAdd; i++) {
                                hexData.push('0x00');
                            }

                            Memory.writeByteArray(match.address, hexData);
                            console.log("\x1b[33m" + '[*] Patch Address: ' + match.address + "\x1b[0m");
                            console.log("\x1b[32m[*] Before Patch: " + patt + '   \x1b[0m------>  ' + "\x1b[32mAfter Patch: " + mempatch + "\x1b[0m");
                            console.log(hexdump(match.address, { offset: 0, length: 32 }));
                            patched = true; 
                        });
                    }
                },
                onComplete: function () {}
            });
        });
    } catch (e) {
    }
}
setInterval(memory, 1000);
```

### Trace
#### Function Trace
```javascript

```
#### Stack Trace
```javascript

```

### ClassLoader
#### Basic
```javascript
Java.perform(function() {
	for(var i=0;i<Java.enumerateClassLoadersSync().length;i++){
		var classLoaderToUse = Java.enumerateClassLoadersSync()[i];
		console.log(`[${i+1}] ${classLoaderToUse}`)
		Java.classFactory.loader = classLoaderToUse;
		try{
			// Hooking Code
		}catch (error){
		}
	}
})
```
#### InMemoryDexDump
```javascript
function InMemoryDexDump(){
    console.log("[*] In Memory Dex Dump v0.1 - @cryptax");
    var count = 0
    Java.perform(function() {
        var memoryclassLoader = Java.use("dalvik.system.InMemoryDexClassLoader");
        memoryclassLoader.$init.overload('java.nio.ByteBuffer', 'java.lang.ClassLoader').implementation = function(dexbuffer, loader) {
            console.log("[*] Hooking InMemoryDexClassLoader");
            count += 1
            var object = this.$init(dexbuffer, loader);
            /* dexbuffer is a Java ByteBuffer
               you cannot dump to /sdcard unless the app has rights to
             */
            var remaining = dexbuffer.remaining();
            const filename = `/data/data/com.dunamu.ustockplus.android/dump${count}.dex`;
            
            console.log("[*] Opening file name=" + filename + " to write " + remaining + " bytes");
            const f = new File(filename, 'wb');
            var buf = new Uint8Array(remaining);
            for (var i = 0; i < remaining; i++) {
                buf[i] = dexbuffer.get();
                //debug: console.log("buf["+i+"]="+buf[i]);
            }
            console.log("[*] Writing " + remaining + " bytes...");
            f.write(buf);
            f.close();
            // checking
            remaining = dexbuffer.remaining();
            if (remaining > 0) {
                console.log("[-] Error: There are " + remaining + " remaining bytes!");
            } else {
                console.log("[+] Dex dumped successfully in " + filename);
            }

            return object;
        }
    });
}
```

### Util
#### String <-> Binary
```javascript
function bin2String(bArr) {
	var JString = Java.use('java.lang.String');
	var str = JString.$new(bArr).toString();

	return str
}

function string2Bin(str) {
    var result = [];
    for (var i = 0; i < str.length; i++) {
      result.push(str.charCodeAt(i));
    }
    return result;
}
```

#### ByteString <-> String
```javascript
// if(byteString!=null) Bytes = byteString.getData$okio();
var Bytes = "okio.ByteString의 Byte 배열" 
var JavaByte = Java.use("[B");
var buffer = Java.cast(Bytes, JavaByte);
var result1 = Java.array('byte', buffer);
var JString = Java.use('java.lang.String');
var str = JString.$new(result1);

let result = "";

// String -> Bytearray
var newStr = `{"pin_txid":"string"}`
var newbyteString = string2Bin(newStr)

var java_bytestr = Java.use('okio.ByteString').$new(newbyteString)
result = this[method](mediaType, java_bytestr);
```

#### OnClickListen
```javascript
function OnClickListener() {
    Java.perform(function () {
        Java.use("android.view.View").setOnClickListener.implementation = function (
            listener
            ) {
            if (listener != null) {
                watch(listener, "onClick");
            }
            return this.setOnClickListener(listener);
        };

        Java.choose("android.view.View$ListenerInfo", {
            onMatch: function (instance) {
                instance = instance.mOnClickListener.value;
                if (instance) {
                console.log("mOnClickListener name is :" + getObjClassName(instance));
                watch(instance, "onClick");
                }
            },
            onComplete: function () {},
        });
    });
}
```